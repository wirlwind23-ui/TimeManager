<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‡ªå¾‹æˆé•¿ç³»ç»Ÿ-å•åˆ—ç¨³å®šç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { --bg: #F0F4F8; --card: #FFFFFF; --primary: #6366F1; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding-bottom: 100px; color: #1E293B; }
        .nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 2000; }
        .nav-item { flex: 1; text-align: center; padding: 15px 0; font-size: 12px; color: #94A3B8; border:none; background:none; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .page { display: none; padding: 10px; max-width: 600px; margin: 0 auto; animation: fadeIn 0.2s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* å½»åº•å¼ºåˆ¶å•åˆ—å¸ƒå±€ */
        .check-grid { display: block; width: 100%; }

        .cat-container { background: white; border-radius: 12px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); margin-bottom: 12px; }
        .task-scroll-area { display: block; } 
        .group-header { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; cursor: pointer; font-weight: 900; font-size: 15px; border-bottom: 1px solid #f1f5f9; margin-bottom: 10px; position: sticky; top: 0; background: white; z-index: 10; }
        .item-row { display: flex; flex-direction: column; padding: 12px; border-radius: 10px; margin-bottom: 8px; border: 1px solid rgba(0,0,0,0.02); }
        .item-main { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
        .name-input { border: none; background: transparent; font-size: 16px; font-weight: 900; width: 100%; color: #1E293B; outline: none; margin-bottom: 4px; }
        .score-row { display: flex; align-items: center; gap: 10px; font-size: 11px; color: #64748B; }
        .score-box { display: flex; align-items: center; gap: 4px; }
        .step-btn { border: 1px solid #E2E8F0; background: white; border-radius: 4px; width: 22px; height: 22px; font-size: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #64748B; font-weight: bold; }
        .score-input { width: 30px; border: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.8); text-align: center; font-size: 12px; font-weight: bold; color: #1E293B; padding: 2px 0; border-radius: 4px; }
        .note-input { width: 100%; border: none; background: rgba(255,255,255,0.5); border-radius: 6px; padding: 6px; margin-top: 8px; font-size: 12px; box-sizing: border-box; border: 1px dashed rgba(0,0,0,0.1); }
        
        .switch { position: relative; width: 44px; height: 24px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top:0; left:0; right:0; bottom:0; background:#E2E8F0; transition:.3s; border-radius:24px; }
        .slider:before { position: absolute; content:""; height:18px; width:18px; left:3px; bottom:3px; background:white; transition:.3s; border-radius:50%; }
        input:checked + .slider { background: #10B981; }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .card { background: white; border-radius: 12px; padding: 12px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        input[type="text"], input[type="number"], select { width: 100%; padding: 10px; margin-bottom: 8px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 14px; box-sizing: border-box;}
        .btn { border: none; padding: 10px 16px; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background: #F8FAFC; padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #F1F5F9; }
        .gain { color: #10B981; font-weight: bold; }
        .loss { color: #EF4444; font-weight: bold; }
        .mini-btn { padding: 6px 10px; border-radius: 6px; font-size: 11px; background: #64748B; color: white; border: none; cursor: pointer; }
        .color-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
    </style>
</head>
<body>

<div id="page-check" class="page active">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
        <div>
            <div id="disp-date" style="color: #1E293B; font-weight: bold; font-size: 16px;"></div>
            <div style="font-size:12px; color:#94A3B8; margin-top:4px;">
                å¾—: <span id="stat-gain" class="gain">0</span> 
                æ”¯: <span id="stat-loss" class="loss">0</span>
            </div>
        </div>
        <div style="text-align: right;">
            <span style="font-size:11px; color:#94A3B8">å¯ç”¨ä½™é¢</span><br>
            <span id="day-total" style="font-size:26px; font-weight:900; color:var(--primary)">0</span>
        </div>
    </div>
    <div id="check-list" class="check-grid"></div>
</div>

<div id="page-history" class="page">
    <h2 style="font-size: 18px;">ç»Ÿè®¡æ˜ç»†</h2>
    <div class="card">
        <div style="font-size: 14px; font-weight: 800; margin-bottom: 10px;">ğŸ’¾ æ•°æ®ç®¡ç†</div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="mini-btn" onclick="exportData(7)">å¯¼å‡ºæœ€è¿‘ä¸€å‘¨</button>
            <button class="mini-btn" onclick="exportData(30)">å¯¼å‡ºæœ€è¿‘ä¸€æœˆ</button>
            <button class="mini-btn" style="background:#10B981" onclick="backupDB()">å…¨é‡å¤‡ä»½/å¯¼å…¥</button>
        </div>
    </div>
    <div class="card"><canvas id="historyChart" height="180"></canvas></div>
    <div class="card" style="padding: 0; overflow: hidden;">
        <table><thead><tr><th>æ—¶é—´</th><th>é¡¹ç›®</th><th>å˜åŠ¨</th><th>å¤‡æ³¨</th></tr></thead><tbody id="excel-body"></tbody></table>
    </div>
</div>

<div id="page-shop" class="page">
    <div style="background: linear-gradient(135deg, #4F46E5, #9333EA); color: white; padding: 30px; border-radius: 20px; text-align: center; margin-bottom: 15px;">
        <div style="font-size: 48px; font-weight: 900;" id="bal-display">0</div>
        <div style="opacity: 0.9; font-size: 13px; margin-top:5px; font-weight:bold">è´¦æˆ·ç§¯åˆ†å¯ç”¨ä½™é¢</div>
    </div>
    <div id="shop-sort-container"></div>
</div>

<div id="page-admin" class="page">
    <h2 style="font-size: 18px;">ç®¡ç†ä¸­å¿ƒ (æŒ‰ä½ â˜° æˆ– â ¿ æ’åº)</h2>
    <div id="admin-sort-container"></div>
    <div class="card">
        <div style="font-size:14px; font-weight:800; margin-bottom:10px">ğŸ“˜ å¢åŠ æ–°ä»»åŠ¡</div>
        <select id="add-item-cat"></select>
        <input type="text" id="add-item-name" placeholder="åç§°">
        <input type="number" id="add-item-base" placeholder="åˆ†å€¼">
        <button class="btn" style="background: var(--primary); width:100%" onclick="op('item')">ç¡®å®šæ·»åŠ </button>
    </div>
    <div class="card">
        <div style="font-size:14px; font-weight:800; margin-bottom:10px">ğŸ å¢åŠ æ–°å¥–å“</div>
        <input type="text" id="add-reward-name" placeholder="åç§°">
        <input type="number" id="add-reward-price" placeholder="åˆ†å€¼">
        <button class="btn" style="background: #ED8936; width:100%" onclick="op('reward')">ç¡®å®šæ·»åŠ </button>
    </div>
    <div class="card">
        <div style="font-size:14px; font-weight:800; margin-bottom:10px">ğŸ“¦ å¢åŠ æ–°åˆ†ç±»</div>
        <input type="text" id="add-cat-name" placeholder="åˆ†ç±»å (å¦‚: ğŸƒ è¿åŠ¨)">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px">
            <span style="font-size:14px">åˆ†ç±»é¢œè‰²:</span>
            <input type="color" id="add-cat-color" value="#6366F1" style="height:35px; width:60px; padding:2px; border:1px solid #ddd; border-radius:4px">
        </div>
        <button class="btn" style="background: #10B981; width:100%" onclick="op('cat')">åˆ›å»ºåˆ†ç±»</button>
    </div>
</div>

<nav class="nav">
    <button class="nav-item active" onclick="tab('check')">æ‰“å¡</button>
    <button class="nav-item" onclick="tab('history')">æ˜ç»†</button>
    <button class="nav-item" onclick="tab('shop')">å•†åº—</button>
    <button class="nav-item" onclick="tab('admin')">ç®¡ç†</button>
</nav>

<script>
// æ‰€æœ‰ 37 ä¸ªä»»åŠ¡é€»è¾‘å®Œå…¨ä¿ç•™
const raw37 = [{id:1, name:"Finish homework", base:5, g:"g1"}, {id:2, name:"Math lesson", base:5, g:"g1"}, {id:3, name:"English lesson", base:5, g:"g1"}, {id:4, name:"English words 5-10", base:3, g:"g1"}, {id:5, name:"Math exercise", base:4, g:"g1"}, {id:6, name:"English practice", base:4, g:"g1"}, {id:7, name:"Reading", base:4, g:"g1"}, {id:8, name:"Writing", base:4, g:"g1"}, {id:9, name:"Speaking", base:4, g:"g1"}, {id:10, name:"Outdoor play", base:5, g:"g1"}, {id:11, name:"Get up on time", base:2, g:"g2"}, {id:12, name:"Brush teeth", base:1, g:"g2"}, {id:13, name:"Brush hair", base:1, g:"g2"}, {id:14, name:"Have water", base:1, g:"g2"}, {id:15, name:"Exercise (AM)", base:3, g:"g2"}, {id:16, name:"Breakfast in 30min", base:5, g:"g2"}, {id:17, name:"Wash face", base:1, g:"g2"}, {id:18, name:"Get dressed", base:2, g:"g2"}, {id:19, name:"Make bed", base:2, g:"g2"}, {id:20, name:"School no late", base:10, g:"g2"}, {id:21, name:"Piano", base:10, g:"g3"}, {id:22, name:"Singing", base:5, g:"g3"}, {id:23, name:"Chinese 5-10min", base:5, g:"g3"}, {id:24, name:"Chess", base:10, g:"g3"}, {id:25, name:"Coding", base:10, g:"g3"}, {id:26, name:"Painting", base:10, g:"g3"}, {id:27, name:"Housework", base:8, g:"g3"}, {id:28, name:"Dinner in 30min", base:5, g:"g4"}, {id:29, name:"Exercise (PM)", base:3, g:"g4"}, {id:30, name:"Clean room/desk", base:5, g:"g4"}, {id:31, name:"Set schoolbag", base:5, g:"g4"}, {id:32, name:"Prepare dress", base:5, g:"g4"}, {id:33, name:"Take shower", base:3, g:"g4"}, {id:34, name:"Brush teeth (PM)", base:1, g:"g4"}, {id:35, name:"Wash clothes/socks", base:5, g:"g4"}, {id:36, name:"Videochat w/Gma", base:5, g:"g4"}, {id:37, name:"Go to bed b/f 8:45", base:10, g:"g4"}];

let db = JSON.parse(localStorage.getItem('kid_v22_final')) || {
    catOrder: ['g_punish', 'g1', 'g2', 'g3', 'g4'],
    cats: {
        g_punish: { n: "âš–ï¸ å¥–æƒ©è®°å½•", cb: "#E11D48", open: true, open_admin: true },
        g1: { n: "ğŸ“˜ å­¦ä¸šæˆ·å¤–", cb: "#2196F3", open: true, open_admin: true },
        g2: { n: "ğŸŒ¸ æ™¨é—´ä¹ æƒ¯", cb: "#E91E63", open: true, open_admin: true },
        g3: { n: "ğŸ¨ å…´è¶£å®¶åŠ¡", cb: "#F59E0B", open: true, open_admin: true },
        g4: { n: "ğŸŒ™ æ™šé—´ç”Ÿæ´»", cb: "#10B981", open: true, open_admin: true }
    },
    tasks: [{id: 999, name: "é¢å¤–è¡¨ç°å¥–åŠ±", base: 10, actual: 10, g: "g_punish"}, {id: 998, name: "è¿è§„è¡Œä¸ºæ‰£åˆ†", base: -10, actual: -10, g: "g_punish"}, ...raw37.map(t => ({...t, actual: t.base}))],
    rewards: [{id: 101, name: "15min å±å¹•æ—¶é—´", base: 30, actual: 30}],
    history: {}, spending: [], balance: 0
};

function save() { localStorage.setItem('kid_v22_final', JSON.stringify(db)); }

function tab(p) {
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
    document.getElementById('page-'+p).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    if(event) event.currentTarget.classList.add('active');
    if(p === 'check') renderCheck();
    if(p === 'history') renderHistory();
    if(p === 'shop') renderShop();
    if(p === 'admin') renderAdmin();
}

function renderCheck() {
    const scrollPos = window.pageYOffset || document.documentElement.scrollTop;
    const today = new Date().toLocaleDateString();
    document.getElementById('disp-date').innerText = today;
    const list = document.getElementById('check-list'); list.innerHTML = '';
    if(!db.history[today]) db.history[today] = {};
    let dayGain = 0, dayLoss = 0;
    
    db.catOrder.forEach(gid => {
        const cat = db.cats[gid];
        const gTasks = db.tasks.filter(t => t.g === gid);
        const gDiv = document.createElement('div'); gDiv.className = 'cat-container';
        const bgColors = { g1: '#E0F2FE', g2: '#FCE7F3', g3: '#FEF3C7', g4: '#DCFCE7', g_punish: '#FFF1F2' };
        
        gDiv.innerHTML = `<div class="group-header" onclick="toggleCat('${gid}')" style="color:${cat.cb}"><span>${cat.n}</span><span>${cat.open?'â–¼':'â–¶'}</span></div>
            <div style="display:${cat.open?'block':'none'}">${gTasks.map(t => {
                const entry = db.history[today][t.id];
                const isDone = entry !== undefined;
                const curVal = isDone ? entry.val : t.actual;
                if(isDone) { if(curVal > 0) dayGain += curVal; else dayLoss += Math.abs(curVal); }
                return `<div class="item-row" style="background:${bgColors[gid] || '#F8FAFC'}">
                    <div class="item-main">
                        <div style="flex:1"><input class="name-input" value="${t.name}" onchange="editT(${t.id},'name',this.value)">
                            <div class="score-row">
                                <span class="score-box">é¢„<button class="step-btn" onclick="adjT(${t.id},'base',-1)">-</button><input type="number" class="score-input" value="${t.base}" onchange="editT(${t.id},'base',this.value)"><button class="step-btn" onclick="adjT(${t.id},'base',1)">+</button></span>
                                <span class="score-box">å®<button class="step-btn" onclick="adjT(${t.id},'actual',-1)">-</button><input type="number" class="score-input" style="color:${cat.cb}; border-color:${cat.cb}" value="${curVal}" onchange="editT(${t.id},'actual',this.value)"><button class="step-btn" onclick="adjT(${t.id},'actual',1)">+</button></span>
                            </div>
                        </div>
                        <label class="switch"><input type="checkbox" ${isDone?'checked':''} onchange="toggleT(${t.id},'${today}')"><span class="slider"></span></label>
                    </div>
                    <input class="note-input" placeholder="æ·»åŠ å¤‡æ³¨..." value="${entry ? entry.note : ''}" onchange="updateNote(${t.id},'${today}',this.value)">
                </div>`;
            }).join('')}</div>`;
        list.appendChild(gDiv);
    });
    document.getElementById('stat-gain').innerText = dayGain;
    document.getElementById('stat-loss').innerText = dayLoss;
    document.getElementById('day-total').innerText = db.balance;
    setTimeout(() => { window.scrollTo(0, scrollPos); }, 0);
}

// åé¢æ‰€æœ‰åŠŸèƒ½å‡½æ•°ä¿æŒä¸å˜
function adjT(id, field, delta) {
    const t = db.tasks.find(x => x.id == id);
    const today = new Date().toLocaleDateString();
    if(field === 'base') t.base = (parseInt(t.base) || 0) + delta;
    else {
        if(db.history[today][id]) {
            db.balance = db.balance - db.history[today][id].val + (db.history[today][id].val + delta);
            db.history[today][id].val += delta;
        } else t.actual = (parseInt(t.actual) || 0) + delta;
    }
    save(); renderCheck();
}
function toggleCat(gid) { db.cats[gid].open = !db.cats[gid].open; save(); renderCheck(); }
function toggleT(tid, date) {
    const t = db.tasks.find(x => x.id == tid);
    if(db.history[date][tid]) { db.balance -= db.history[date][tid].val; delete db.history[date][tid]; }
    else { db.history[date][tid] = { val: t.actual, note: "" }; db.balance += t.actual; }
    save(); renderCheck();
}
function editT(id, f, val) {
    const t = db.tasks.find(x => x.id == id);
    const n = parseInt(val) || 0;
    if(f==='name') t.name = val;
    else if(f==='base') t.base = n;
    else if(f==='actual') {
        const d = new Date().toLocaleDateString();
        if(db.history[d][id]) { db.balance = db.balance - db.history[d][id].val + n; db.history[d][id].val = n; }
        else t.actual = n;
    }
    save(); renderCheck();
}
function updateNote(tid, date, txt) { if(db.history[date][tid]) { db.history[date][tid].note = txt; save(); } }
function renderShop() {
    document.getElementById('bal-display').innerText = db.balance;
    const container = document.getElementById('shop-sort-container'); container.innerHTML = '';
    db.rewards.forEach(r => {
        const div = document.createElement('div'); div.className = 'item-row'; div.style.background = '#F8FAFC';
        div.innerHTML = `<div class="item-main"><div><input class="name-input" value="${r.name}" onchange="editR(${r.id},'name',this.value)">
            <div class="score-row">æ ‡ä»·: <input type="number" class="score-input" value="${r.base}" onchange="editR(${r.id},'base',this.value)"> 
            æ‰£é™¤: <button class="step-btn" onclick="adjR(${r.id},-1)">-</button><input type="number" id="cur-r-${r.id}" class="score-input" value="${r.actual}"><button class="step-btn" onclick="adjR(${r.id},1)">+</button></div></div>
            <button onclick="buyR(${r.id})" style="background:#ED8936; color:white; border:none; padding:8px 12px; border-radius:8px; font-weight:bold">å…‘æ¢</button></div>`;
        container.appendChild(div);
    });
}
function adjR(id, d) { const r = db.rewards.find(x=>x.id==id); r.actual += d; save(); renderShop(); }
function buyR(id) {
    const r = db.rewards.find(x => x.id === id);
    const act = parseInt(document.getElementById(`cur-r-${id}`).value) || 0;
    if(db.balance >= act && confirm(`ç¡®å®šå…‘æ¢ ${r.name}ï¼Ÿ`)) {
        db.balance -= act;
        db.spending.push({ date: new Date().toLocaleDateString(), name: "ğŸ "+r.name, val: -act, note: "å…‘æ¢", type: 'loss' });
        save(); renderShop();
    } else if(db.balance < act) alert('ç§¯åˆ†ä¸è¶³');
}
function editR(id, f, v) { const r = db.rewards.find(x=>x.id==id); if(f==='name') r.name = v; else { r.base = parseInt(v); r.actual = r.base; } save(); renderShop(); }
function renderAdmin() {
    const container = document.getElementById('admin-sort-container'); container.innerHTML = '';
    const sel = document.getElementById('add-item-cat'); sel.innerHTML = '';
    db.catOrder.forEach(gid => {
        const cat = db.cats[gid]; sel.innerHTML += `<option value="${gid}">${cat.n}</option>`;
        const gCard = document.createElement('div'); 
        gCard.className = 'card admin-cat-card'; 
        gCard.dataset.id = gid;
        gCard.style.borderLeft = `4px solid ${cat.cb}`;
        gCard.innerHTML = `<div class="group-header">
            <span onclick="db.cats['${gid}'].open_admin=!db.cats['${gid}'].open_admin;save();renderAdmin()">
                <span class="color-dot" style="background:${cat.cb}"></span>${cat.n} ${cat.open_admin?'â–¼':'â–¶'}
            </span>
            <div style="display:flex; gap:10px; align-items:center">
                <input type="color" value="${cat.cb}" onchange="db.cats['${gid}'].cb=this.value;save();renderAdmin()" style="width:20px;height:20px;border:none;background:none;padding:0">
                <span class="cat-handle" style="cursor:move; color:#CBD5E1">â˜°</span>
            </div>
        </div>
        <div class="admin-task-list" data-gid="${gid}" style="display:${cat.open_admin?'block':'none'}">
            ${db.tasks.filter(t => t.g === gid).map(t => `
                <div class="item-row admin-task-item" style="background:#f8fafc; margin-bottom:5px" data-tid="${t.id}">
                    <div class="item-main">
                        <span style="flex:1; font-size:12px; font-weight:700;"><span style="color:#CBD5E1;margin-right:8px">â ¿</span>${t.name}</span>
                        <span style="color:#EF4444; font-size:10px; cursor:pointer" onclick="delT(${t.id})">ç§»é™¤</span>
                    </div>
                </div>`).join('')}
        </div>`;
        container.appendChild(gCard);
    });
    Sortable.create(container, {
        handle: '.cat-handle', animation: 150,
        onEnd: () => {
            db.catOrder = Array.from(container.querySelectorAll('.admin-cat-card')).map(el => el.dataset.id);
            save();
        }
    });
    container.querySelectorAll('.admin-task-list').forEach(el => {
        Sortable.create(el, {
            animation: 150, handle: '.admin-task-item',
            onEnd: () => {
                const gid = el.dataset.gid;
                const tids = Array.from(el.querySelectorAll('.admin-task-item')).map(row => parseInt(row.dataset.tid));
                const others = db.tasks.filter(t => t.g !== gid);
                const current = tids.map(id => db.tasks.find(t => t.id === id));
                db.tasks = [...others, ...current];
                save();
            }
        });
    });
}
function op(type) {
    if(type==='item') {
        const n = document.getElementById('add-item-name').value;
        const b = parseInt(document.getElementById('add-item-base').value) || 0;
        const g = document.getElementById('add-item-cat').value;
        if(n) { db.tasks.push({id:Date.now(), name:n, base:b, actual:b, g:g}); save(); renderAdmin(); }
    } else if(type==='reward') {
        const n = document.getElementById('add-reward-name').value;
        const p = parseInt(document.getElementById('add-reward-price').value) || 0;
        if(n) { db.rewards.push({id:Date.now(), name:n, base:p, actual:p}); save(); tab('shop'); }
    } else if(type==='cat') {
        const n = document.getElementById('add-cat-name').value;
        const c = document.getElementById('add-cat-color').value;
        if(n) { const id='g'+Date.now(); db.cats[id]={n:n, cb:c, open:true, open_admin:true}; db.catOrder.push(id); save(); renderAdmin(); }
    }
}
function renderHistory() {
    const dates = Object.keys(db.history).sort().slice(-7);
    const scores = dates.map(d => Object.values(db.history[d]).reduce((a,b)=>a+b.val, 0));
    const ctx = document.getElementById('historyChart').getContext('2d');
    if(window.ch) window.ch.destroy();
    window.ch = new Chart(ctx, { type:'line', data:{ labels:dates, datasets:[{label:'æ¯æ—¥è·å¾—', data:scores, borderColor:'#6366F1', tension:0.4}] }, options:{plugins:{legend:{display:false}}}});
    const tbody = document.getElementById('excel-body'); tbody.innerHTML = '';
    let logs = [];
    Object.keys(db.history).forEach(d => { Object.entries(db.history[d]).forEach(([tid, entry]) => {
        const t = db.tasks.find(x => x.id == tid); logs.push({ date: d, name: t?t.name:'é¡¹', val: entry.val, note: entry.note, type: entry.val>=0?'gain':'loss' });
    });});
    db.spending.forEach(s => logs.push({...s}));
    logs.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(log => {
        tbody.innerHTML += `<tr><td>${log.date.split('/').slice(1).join('/')}</td><td style="font-weight:900">${log.name}</td><td class="${log.type}">${log.val>=0?'+':''}${log.val}</td><td>${log.note || ''}</td></tr>`;
    });
}
function exportData(days) {
    let output = `è‡ªå¾‹ç³»ç»ŸæŠ¥è¡¨ (æœ€è¿‘${days}å¤©)\né¡¹ç›®\tå˜åŠ¨\tæ—¶é—´\n`;
    const rows = document.querySelectorAll("#excel-body tr");
    rows.forEach(row => {
        const cols = row.querySelectorAll("td");
        output += `${cols[1].innerText}\t${cols[2].innerText}\t${cols[0].innerText}\n`;
    });
    const el = document.createElement('textarea'); el.value = output; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); alert('æŠ¥è¡¨æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
}
function backupDB() {
    const action = prompt("1:å¯¼å‡ºå¤‡ä»½ 2:å¯¼å…¥æ•°æ®");
    if(action === '1') {
        const str = btoa(unescape(encodeURIComponent(JSON.stringify(db))));
        const el = document.createElement('textarea'); el.value = str; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); alert('å¤‡ä»½ç å·²å¤åˆ¶ï¼');
    } else if(action === '2') {
        const code = prompt("ç²˜è´´å¤‡ä»½ç :");
        if(code) { try { db = JSON.parse(decodeURIComponent(escape(atob(code)))); save(); location.reload(); } catch(e){alert("é”™è¯¯!");} }
    }
}
function delT(id) { if(confirm('ç§»é™¤ï¼Ÿ')) { db.tasks = db.tasks.filter(t=>t.id!=id); save(); renderAdmin(); } }
renderCheck();
</script>
</body>
</html>
